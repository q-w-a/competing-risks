---
title: "Simulation"
author: "Quinn White"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
theme_c <- function(...){ 
   # font <- "Helvetica"   #assign font family up front
  #  font <- "Arial"
    theme_bw() %+replace%    #replace elements we want to change
    
    theme(
      
      #text elements
      plot.title = element_text(             #title
                 #  family = font,            #set font family
                   size = 11,                #set font size
                   face = 'bold',            #bold typeface
                   hjust = .5,
                   vjust = 3),               
      
      plot.subtitle = element_text(          #subtitle
                #   family = font,            #font family
                   size = 10,
                   hjust = .5,
                   face = 'italic',
                   vjust = 3),               #font size
      
      axis.title = element_text(             #axis titles
                #   family = font,            #font family
                   size = 10),               #font size
      
      axis.text = element_text(              #axis text
                #   family = font,            #axis famuly
                   size = 8),
      strip.text = element_text(color="white", size = 9,
                                margin=unit(c(.1,.1,.1,.1), 'cm')),
      strip.background = element_rect(fill = "#363636"),
      # t, r, b, l
      plot.margin = unit(c(1,.5,.5,.5), "cm")
      ) %+replace%
      theme(...)
   
}


```

Let $L_k$ be an indicator for family history of heart disease.  Since this covariate does not change with time, we have $L_0=L_1=\cdots = L_k$. Let $A$ be the treatment assigment (e.g., an ACE inhibitor).



```{r}

n <- 1000

set.seed(999)
baseline <- tibble(
  # baseline covariates
  l0 = rbinom(n, 1, .5),
  # treatment assigment
  a0 = rbinom(n, 1, .5),
  time_point = 1)


A1_L1_P_D <- .12 
A1_L0_P_D <- .05
A0_L1_P_D <- .1
A0_L0_P_D <- .08


A1_L1_P_Y <- .2
A1_L0_P_Y <- .1
A0_L1_P_Y <- .3
A0_L0_P_Y <- .25

sim_dat <- map_df(1:n, ~ {
   baseline[.x,] %>%
     mutate(dk = case_when(
      a0 == 1 & l0 == 1 ~ rbinom(1,1, A1_L1_P_D),
      a0 == 1 & l0 == 0 ~ rbinom(1,1, A1_L0_P_D),
      a0 == 0 & l0 == 1 ~ rbinom(1,1,  A0_L1_P_D),
      a0 == 0 & l0 ==0 ~ rbinom(1, 1, A0_L0_P_D)
    ),
    dk_A_0 = case_when(
      # consistency 
      a0 == 0 ~ dk,
      # if a0 == 1 and l0 == 1, simulate as if a0 == 0 and l0 == 1
      a0 == 1 & l0 == 1 ~ rbinom(1,1, A0_L1_P_D),
      # if a0 == 1 and l0 == 0, simulate as if a0 == 0 and l0 == 0
      a0 == 1 & l0 == 0 ~ rbinom(1, 1, A0_L0_P_D)),
    dk_A_1 = case_when(
      # consistency
      a0 == 1 ~ dk,
      # if a0 == 0 and l0 == 1, simulate as if a0 == 1 and l0 ==1
      a0 == 0 & l0 == 1 ~ rbinom(1,1, A1_L1_P_D),
      # if a0 == 0 and l0 == 0, simulate as if a0 == 1 and l0 ==0
      a0 == 0 & l0 ==0 ~ rbinom(1,1, A1_L0_P_D)
    ),
    yk = case_when(
      # if they have the competing event, cannot have the event of interest
      dk == 1 ~ 0, 
      a0 == 1 & l0 == 1 ~ rbinom(1,1, A1_L1_P_Y),
      a0 == 1 & l0 == 0 ~ rbinom(1,1, A1_L0_P_Y),
      a0 ==0 & l0 == 1 ~ rbinom(1,1, A0_L1_P_Y),
      a0 == 0 & l0 ==0 ~ rbinom(1, 1, A0_L0_P_Y)
    ),
    yk_A_0 = case_when(
       # if they have the competing event, cannot have the event of interest
      # this remains true when considering a0 == 0
      dk == 1 ~ 0, 
      # consistency
      a0 == 0 ~ yk,
      # simulate as if they had a0 == 0 and l0 == 1
      a0 == 1 & l0 == 1 ~ rbinom(1,1,A0_L1_P_Y),
      # simulate as if they had a0 == 0 and l0 == 0
      a0 == 1 & l0 == 0 ~ rbinom(1,1, A0_L0_P_Y)
    ),
      yk_A_1 = case_when(
       # if they have the competing event, cannot have the event of interest
      # this remains true when considering a0 == 0
      dk == 1 ~ 0, 
      # consistency
      a0 == 1 ~ yk,
      # simulate as if they had a0 == 1 and l0 == 1
      a0 == 0 & l0 == 1 ~ rbinom(1,1,A1_L1_P_Y),
      # simulate as if they had a0 == 0 and l0 == 0
      a0 == 0 & l0 == 0 ~ rbinom(1,1, A1_L0_P_Y)
    ),
    yk_A_0_D_0 = case_when(
      # simulate as if they had no competing event and a0==0
      # consistency 
      dk == 0 & a0 == 0 ~ yk,
      # use previously generated potential outcomes when dk=0
      dk == 0 & a0 == 1 & l0 == 1 ~ yk_A_0,
      dk == 0 & a0 == 1 & l0 == 0 ~ yk_A_0,
      # when dk = 1 generate potential outcomes for these cases 
      dk == 1 & a0 %in% c(0,1) & l0 == 1 ~ rbinom(1,1, A0_L1_P_Y),
      dk == 1 & a0 %in% c(0,1) & l0 == 0 ~ rbinom(1,1, A0_L0_P_Y)
    ),
    yk_A_1_D_0 = case_when(
      # simulate as if they had no competing event and a0==1
      # consistency 
      dk == 0 & a0 == 1 ~ yk,
      # use previously generated potential outcomes when dk=0
      dk == 0 & a0 == 0 & l0 == 1 ~ yk_A_1,
      dk == 0 & a0 == 0 & l0 == 0 ~ yk_A_1,
      # when dk = 1 generate potential outcomes for these cases 
      dk == 1 & a0 %in% c(0,1) & l0 == 1 ~ rbinom(1,1, A1_L1_P_Y),
      dk == 1 & a0 %in% c(0,1) & l0 == 0 ~ rbinom(1,1, A1_L0_P_Y)
    )
    )})




label_a <- function(string, prefix = "A=") paste0(prefix, string)
label_l <- function(string, prefix = "L=") paste0(prefix, string)


# sim_dat %>%
#   pivot_longer(cols=contains("k")) %>%
#   group_by(name,l0, a0) %>%
#   summarize(prop = sum(value) /n()) %>%
#   ggplot(aes(y= name, x = prop)) +
#   geom_bar(stat="identity") +
#   facet_grid(l0~a0, labeller = labeller(a0=label_a, l0 = label_l)) +
#   theme_c()



sim_dat %>%
  pivot_longer(cols=contains("k")) %>%
  group_by(name,l0, a0) %>%
  mutate(a0 = ifelse(a0 == 0, "Control", "Treatment")) %>%
  summarize(prop = sum(value) /n()) %>%
  ggplot(aes(y= name, x = prop, fill = factor(a0))) +
  geom_bar(stat="identity", position="dodge", alpha=.8) +
  facet_wrap(~l0, labeller = labeller( l0 = label_l)) +
  theme_c() +
  labs(fill="", x= "Proportion who had Event") +
  viridis::scale_fill_viridis(discrete=TRUE, 
                              begin=.1, 
                              end=.8) 



```

